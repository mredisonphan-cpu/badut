<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport"
      content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no,viewport-fit=cover"/>
<title>B√Ä ƒê·ª§T ‚Äì iPhone Anti-Zoom + Camera</title>
<style>
  html,body{
    margin:0;height:100%;
    overflow:hidden;
    background:#0b2b3a;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
    -webkit-user-select:none; user-select:none;
    -webkit-text-size-adjust:100%;
    touch-action:none;
    overscroll-behavior:none;
    position:fixed; inset:0; /* ch·ªëng iOS bounce */
  }
  canvas{
    width:100vw;height:100vh; display:block;
    background:linear-gradient(180deg,#0b2b3a 0%,#171033 100%);
    touch-action:none;
  }

  #hud{ position:fixed; inset:0; pointer-events:none; touch-action:none; }
  :root{
    --safeT: env(safe-area-inset-top);
    --safeR: env(safe-area-inset-right);
    --safeB: env(safe-area-inset-bottom);
    --safeL: env(safe-area-inset-left);
  }
  .btn{
    position:absolute;
    pointer-events:auto;
    display:grid; place-items:center;
    font-weight:900; color:#fff;
    border-radius:18px;
    background:rgba(30,255,214,0.18);
    border:1px solid rgba(30,255,214,0.45);
    border-bottom:2px solid rgba(255,107,155,0.35);
    backdrop-filter:blur(10px) saturate(140%);
    -webkit-backdrop-filter:blur(10px) saturate(140%);
    box-shadow:0 10px 28px rgba(0,0,0,.22);
    touch-action:none;
  }
  .btn:active{ background:rgba(255,107,155,0.25); transform:scale(.97); }

  #left,#right{
    width:72px;height:72px;
    bottom:calc(18px + var(--safeB));
    font-size:26px;
  }
  #left { left:calc(18px + var(--safeL)); }
  #right{ left:calc(104px + var(--safeL)); }

  #jump{
    width:96px;height:96px;
    bottom:calc(18px + var(--safeB));
    right:calc(18px + var(--safeR));
    font-size:16px;
  }
  #fart{
    width:88px;height:70px;
    bottom:calc(126px + var(--safeB));
    right:calc(22px + var(--safeR));
    font-size:16px;
  }
  #reset{
    width:60px;height:44px;
    top:calc(12px + var(--safeT));
    right:calc(12px + var(--safeR));
    font-size:14px;
    border-radius:14px;
  }
</style>
</head>
<body>
<canvas id="c"></canvas>

<div id="hud">
  <div id="left"  class="btn">‚Üê</div>
  <div id="right" class="btn">‚Üí</div>
  <div id="jump"  class="btn">JUMP</div>
  <div id="fart"  class="btn">üí®</div>
  <div id="reset" class="btn">R</div>
</div>

<script>
(() => {
  /* ================= iOS ANTI-ZOOM (TRI·ªÜT) ================= */
  // ch·∫∑n pinch gesture
  ["gesturestart","gesturechange","gestureend"].forEach(evt=>{
    document.addEventListener(evt, e=>e.preventDefault(), {passive:false});
  });

  // ch·∫∑n scroll/bounce
  document.addEventListener("touchmove", e=>e.preventDefault(), {passive:false});

  // ch·∫∑n double tap zoom
  let lastTap = 0;
  document.addEventListener("touchend", (e)=>{
    const now = Date.now();
    if(now - lastTap < 280) e.preventDefault();
    lastTap = now;
  }, {passive:false});

  // ch·∫∑n 2 ng√≥n (pinch) + m·ªçi touch multi
  document.addEventListener("touchstart", (e)=>{
    if(e.touches && e.touches.length > 1) e.preventDefault();
  }, {passive:false});

  /* ================= Canvas ================= */
  const canvas = document.getElementById("c");
  const ctx = canvas.getContext("2d", {alpha:false});

  function resize(){
    const dpr = Math.max(1, Math.min(3, window.devicePixelRatio || 1));
    canvas.width = Math.floor(innerWidth * dpr);
    canvas.height = Math.floor(innerHeight * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  addEventListener("resize", resize, {passive:true});
  resize();

  const W=()=>innerWidth, H=()=>innerHeight;

  /* ================= Input (touchstart/touchend cho iOS) ================= */
  const V = {l:false,r:false,j:false,f:false, reset:false};

  function bindHold(id, key){
    const el=document.getElementById(id);
    const on = (e)=>{ e.preventDefault(); V[key]=true; };
    const off= (e)=>{ e.preventDefault(); V[key]=false; };

    el.addEventListener("touchstart", on, {passive:false});
    el.addEventListener("touchend", off, {passive:false});
    el.addEventListener("touchcancel", off, {passive:false});

    // v·∫´n h·ªó tr·ª£ pointer cho m√°y kh√°c
    el.addEventListener("pointerdown", on, {passive:false});
    el.addEventListener("pointerup", off, {passive:false});
    el.addEventListener("pointercancel", off, {passive:false});
    el.addEventListener("pointerleave", off, {passive:false});
  }
  bindHold("left","l");
  bindHold("right","r");
  bindHold("jump","j");
  bindHold("fart","f");

  const resetBtn=document.getElementById("reset");
  resetBtn.addEventListener("touchstart",(e)=>{e.preventDefault(); V.reset=true;},{passive:false});
  resetBtn.addEventListener("pointerdown",(e)=>{e.preventDefault(); V.reset=true;},{passive:false});

  /* ================= Utils ================= */
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const rects=(a,b)=>a.x<b.x+b.w && a.x+a.w>b.x && a.y<b.y+b.h && a.y+a.h>b.y;

  /* ================= World / Level (d√†i h∆°n + camera) ================= */
  const TILE=48;
  const level = [
"############################################################################################################",
"#..................................................o...............o...............o......................#",
"#..................o......................o..................o................o............................#",
"#..S....######...............######.....................######.............######....................F.....#",
"#.............o...........o.............o......................o...........................................#",
"#...........#########################.................#####################.................................#",
"#..................................................o...............o...............o......................#",
"#..........................................................................................................#",
"############################################################################################################"
  ];

  const blocks=[], foods=[];
  let start={x:80,y:80}, finish={x:0,y:0};
  const worldW = level[0].length * TILE;
  const worldH = level.length * TILE;

  for(let y=0;y<level.length;y++){
    const row=level[y];
    for(let x=0;x<row.length;x++){
      const ch=row[x];
      const px=x*TILE, py=y*TILE;
      if(ch==="#") blocks.push({x:px,y:py,w:TILE,h:TILE});
      if(ch==="o") foods.push({x:px+14,y:py+14,w:20,h:20,alive:true});
      if(ch==="S") start={x:px+10,y:py-10};
      if(ch==="F") finish={x:px+10,y:py-10,w:TILE,h:TILE};
    }
  }

  /* ================= Player + Physics ================= */
  const GRAV=2400;
  const MOVE=950;
  const MAXS=320;

  const KG_MIN=40, KG_MAX=130;
  const player={
    x:start.x,y:start.y,vx:0,vy:0,
    kg:55, onGround:false,
    jumps:2,
    fartCD:0,
    dead:false,
    score:0
  };

  // camera
  const cam={x:0,y:0};

  function reset(){
    player.x=start.x; player.y=start.y;
    player.vx=0; player.vy=0;
    player.kg=55; player.jumps=2;
    player.onGround=false;
    player.fartCD=0;
    player.dead=false;
    player.score=0;
    for(const f of foods) f.alive=true;
  }

  function playerRadius(){
    // "tr√≤n ra" theo kg (b√©o tr√≤n ch·ª© kh√¥ng ch·ªâ scale)
    const t = clamp((player.kg-50)/(125-50),0,1);
    return 18 + t*18; // 18..36
  }

  function step(dt){
    if(player.dead) return;

    player.fartCD = Math.max(0, player.fartCD - dt);

    // move
    let ax=0;
    if(V.l) ax -= MOVE;
    if(V.r) ax += MOVE;
    player.vx += ax*dt;

    // drag
    if(!V.l && !V.r) player.vx *= Math.pow(0.82, 60*dt);
    player.vx = clamp(player.vx, -MAXS, MAXS);

    // jump (edge trigger)
    step.prevJ = step.prevJ ?? false;
    if(V.j && !step.prevJ && player.jumps>0){
      // kg n·∫∑ng nh·∫£y y·∫øu h∆°n
      const t = clamp((player.kg-50)/(125-50),0,1);
      const jp = 760 - t*260;
      player.vy = -jp;
      player.jumps--;
    }
    step.prevJ = V.j;

    // fart
    if(V.f && player.fartCD<=0){
      player.kg = Math.max(KG_MIN, player.kg * 0.999); // gi·∫£m nh·∫π
      player.fartCD = 0.12;
    }

    // gravity
    player.vy += GRAV*dt;

    // move X
    player.x += player.vx*dt;

    // collide X (d√πng collider vu√¥ng cho ƒë∆°n gi·∫£n)
    const r=playerRadius();
    let pr={x:player.x, y:player.y, w:r*2, h:r*2};
    for(const b of blocks){
      if(!rects(pr,b)) continue;
      if(player.vx>0) player.x = b.x - pr.w;
      else if(player.vx<0) player.x = b.x + b.w;
      player.vx=0;
      pr.x=player.x;
    }

    // move Y
    player.y += player.vy*dt;
    pr={x:player.x,y:player.y,w:r*2,h:r*2};
    player.onGround=false;
    for(const b of blocks){
      if(!rects(pr,b)) continue;
      if(player.vy>0){
        player.y = b.y - pr.h;
        player.vy = 0;
        player.onGround=true;
        player.jumps=2;
      }else if(player.vy<0){
        player.y = b.y + b.h;
        player.vy=0;
      }
      pr.y=player.y;
    }

    // eat food
    for(const f of foods){
      if(!f.alive) continue;
      if(rects(pr,f)){
        f.alive=false;
        player.kg = Math.min(KG_MAX, player.kg + 2);
        player.score += 10;
      }
    }

    // fall death
    if(player.y > worldH + 200) player.dead=true;

    // finish
    if(rects(pr, finish)){
      player.score += 200;
      // loop l·∫°i cho b·∫°n test
      reset();
    }
  }

  /* ================= Render ================= */
  function draw(){
    ctx.clearRect(0,0,W(),H());

    // BG neon
    const g=ctx.createLinearGradient(0,0,0,H());
    g.addColorStop(0,"#18ffd6");
    g.addColorStop(1,"#ff6b9b");
    ctx.fillStyle=g;
    ctx.fillRect(0,0,W(),H());

    // camera follow
    cam.x = clamp(player.x - W()*0.45, 0, Math.max(0, worldW - W()));
    cam.y = clamp(player.y - H()*0.55, 0, Math.max(0, worldH - H()));

    ctx.save();
    ctx.translate(-cam.x, -cam.y);

    // blocks
    ctx.fillStyle="rgba(10,12,30,0.65)";
    for(const b of blocks) ctx.fillRect(b.x,b.y,b.w,b.h);

    // foods
    ctx.fillStyle="#ff6b9b";
    for(const f of foods){
      if(!f.alive) continue;
      ctx.fillRect(f.x,f.y,f.w,f.h);
    }

    // finish
    ctx.fillStyle="rgba(30,255,214,0.35)";
    ctx.fillRect(finish.x, finish.y, finish.w, finish.h);

    // player (tr√≤n)
    const r=playerRadius();
    ctx.fillStyle="#ffe0c2";
    ctx.beginPath();
    ctx.arc(player.x+r, player.y+r, r, 0, Math.PI*2);
    ctx.fill();

    ctx.restore();

    // HUD
    ctx.fillStyle="rgba(24,255,214,0.18)";
    ctx.fillRect(12, 12, 220, 44);
    ctx.fillStyle="#0b0f1f";
    ctx.font="900 14px system-ui";
    ctx.fillText(`KG: ${player.kg.toFixed(2)} | Score: ${player.score}`, 22, 40);

    if(player.dead){
      ctx.fillStyle="rgba(0,0,0,0.45)";
      ctx.fillRect(0,0,W(),H());
      ctx.fillStyle="#fff";
      ctx.font="900 24px system-ui";
      ctx.fillText("X·ªàU üòµ  ‚Äî b·∫•m R", 22, 120);
    }
  }

  /* ================= Loop (fix dt frame ƒë·∫ßu) ================= */
  let last=0, acc=0;
  const FIXED=1/120, MAXF=1/20;

  function loop(t){
    if(!last) last=t;
    let frame=(t-last)/1000;
    last=t;
    frame=Math.min(frame, MAXF);

    if(V.reset){
      V.reset=false;
      reset();
    }

    acc += frame;
    while(acc>=FIXED){
      step(FIXED);
      acc -= FIXED;
    }
    draw();
    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);

})();
</script>
</body>
</html>